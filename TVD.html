<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Target Value Design Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles/tvd.css">
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Splash Screen -->
    <div id="splash-screen" class="flex flex-col justify-center items-center min-h-screen p-8">
        <div class="w-full max-w-2xl text-center">
            <h1 class="text-4xl font-bold text-gray-900">Target Value Design Tool</h1>
            <p class="text-gray-600 mt-2 mb-8">Upload your project data to begin visualizing your budget.</p>
            <div id="file-drop-zone" class="bg-white p-10 rounded-lg shadow-sm border-2 border-dashed border-gray-300 cursor-pointer">
                <p class="text-gray-500">Drag & drop a JSON file here</p>
                <p class="text-sm text-gray-400 my-2">or</p>
                <input type="file" id="file-input" class="hidden">
                <!-- FIX: Removed the `for` attribute to prevent double-click bug -->
                <label class="inline-block bg-blue-500 text-white px-5 py-2.5 rounded-md font-medium hover:bg-blue-600 transition cursor-pointer">Select File</label>
            </div>
            <div class="mt-6 flex flex-col sm:flex-row justify-center items-center gap-4">
                <button id="use-sample-data-btn" class="w-full sm:w-auto bg-gray-600 text-white px-5 py-2.5 rounded-md font-medium hover:bg-gray-700 transition">Use Sample Data</button>
                <button id="download-template-btn" class="w-full sm:w-auto bg-green-600 text-white px-5 py-2.5 rounded-md font-medium hover:bg-green-700 transition">Download JSON Template</button>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="main-content" class="container mx-auto p-4 md:p-8">
        <header class="mb-2 flex justify-between items-center flex-wrap gap-4">
            <div class="flex flex-col mb-2">
                <div class="flex gap-4 mb-2">
                    <img src="img/wsu.svg" alt="WSU Logo" style="width:55px; max-width:100%; height:auto;" />
                    <img src="img/hoffman.svg" alt="Hoffman Logo" style="width:105px; max-width:100%; height:auto;" />
                    <img src="img/zgf.svg" alt="ZGF Logo" style="width:85px; max-width:100%; height:auto;" />
                </div>
                <h1 class="text-3xl font-bold text-gray-900">WSU Integrated Science Building</h1>
                <p id="file-name" class="text-gray-600 mt-1"></p>
            </div>
            <div class="flex flex-col items-end gap-2 ml-4">
                <div class="flex items-center gap-2">
                    <button id="export-json-btn" class="bg-green-600 text-white py-2 px-4 rounded-md font-semibold hover:bg-green-700 transition">Export JSON</button>
                    <button id="export-csv-btn" class="bg-blue-600 text-white py-2 px-4 rounded-md font-semibold hover:bg-blue-700 transition">Export CSV</button>
                    <button id="start-over-btn" class="bg-gray-500 text-white py-2 px-4 rounded-md font-semibold hover:bg-gray-600 transition">Start Over</button>
                    <button id="reset-button" class="bg-red-500 text-white py-2 px-4 rounded-md font-semibold hover:bg-red-600 transition disabled:bg-gray-300 disabled:cursor-not-allowed">Reset to Original</button>
                </div>
            </div>
        </header>
        
        <div id="phase-selector" class="flex justify-center my-4 gap-2">
            <button id="phase1-btn" class="phase-btn py-2 px-4 rounded-md font-semibold">Phase 1</button>
            <button id="phase2-btn" class="phase-btn py-2 px-4 rounded-md font-semibold">Phase 2</button>
        </div>

        <div id="legend" class="flex justify-center items-center gap-6 my-4 text-sm text-gray-600 flex-wrap">
            <div class="flex items-center gap-2"><div class="w-4 h-4 flex flex-col justify-between items-center"><div class="h-0.5 w-full" style="background-color: #38bdf8;"></div><div class="h-2.5 w-0.5" style="background-color: #38bdf8;"></div><div class="h-0.5 w-full" style="background-color: #38bdf8;"></div></div><span>Project Benchmark</span></div>
            <div class="flex items-center gap-2"><div class="w-4 h-1 rounded-full" style="background-color: #ef4444;"></div><span>Target Value</span></div>
            <div class="flex items-center gap-2"><div class="w-4 h-1.5 rounded-full" style="background-color: #1f2937;"></div><span>Current ROM</span></div>
        </div>

        <main><div id="main-chart" class="relative"><div id="y-axis-labels-container" class="y-axis-labels"></div><div id="chart-container" class="chart-container"></div></div></main>

        <footer id="summary-panel" class="mt-8 bg-white p-4 rounded-lg shadow-md border border-gray-200">
            <!-- Phase 1 Summary -->
            <div class="mb-4">
                <h2 class="text-lg font-bold text-gray-700 mb-2">Phase 1</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                    <div><h3 class="text-sm font-medium text-gray-500">Total Project Budget</h3><p id="total-budget-p1" class="text-xl font-bold text-gray-800"></p></div>
                    <div><h3 class="text-sm font-medium text-gray-500">Target Cost ($/SF)</h3><p id="target-cost-p1" class="text-xl font-semibold text-blue-600"></p></div>
                    <div><h3 class="text-sm font-medium text-gray-500">Current Cost ($/SF)</h3><p id="current-cost-p1" class="text-xl font-semibold text-gray-800"></p></div>
                    <div><h3 class="text-sm font-medium text-gray-500">Variance ($/SF)</h3><p id="variance-p1" class="text-xl font-bold"></p></div>
                </div>
            </div>
            <!-- Divider -->
            <hr class="my-4 border-gray-300">
            <!-- Phase 2 Summary -->
            <div>
                <h2 class="text-lg font-bold text-gray-700 mb-2">Phase 2</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                    <div><h3 class="text-sm font-medium text-gray-500">Total Project Budget</h3><p id="total-budget-p2" class="text-xl font-bold text-gray-800"></p></div>
                    <div><h3 class="text-sm font-medium text-gray-500">Target Cost ($/SF)</h3><p id="target-cost-p2" class="text-xl font-semibold text-blue-600"></p></div>
                    <div><h3 class="text-sm font-medium text-gray-500">Current Cost ($/SF)</h3><p id="current-cost-p2" class="text-xl font-semibold text-gray-800"></p></div>
                    <div><h3 class="text-sm font-medium text-gray-500">Variance ($/SF)</h3><p id="variance-p2" class="text-xl font-bold"></p></div>
                </div>
            </div>
        </footer>
    </div>

    <script>
        // --- INITIAL SETUP AND SAMPLE DATA ---
        const sampleData = {
            "phases": {
                "phase1": {
                    "totalProjectBudget": 20000000,
                    "projectAreaSF": 30000,
                    "components": [
                        { "name": "General Conditions", "benchmark_low": 20, "benchmark_high": 35, "target_value": 30, "current_rom": 29 },
                        { "name": "Demo", "benchmark_low": 22, "benchmark_high": 28, "target_value": 25, "current_rom": 26 },
                        { "name": "Site", "benchmark_low": 42, "benchmark_high": 62, "target_value": 55, "current_rom": 52 },
                        { "name": "Utilities", "benchmark_low": 30, "benchmark_high": 50, "target_value": 40, "current_rom": 38 },
                        { "name": "Weatherproofing", "benchmark_low": 15, "benchmark_high": 30, "target_value": 25, "current_rom": 22 }
                    ]
                },
                "phase2": {
                    "totalProjectBudget": 40000000,
                    "projectAreaSF": 60000,
                    "components": [
                        { "name": "General Conditions", "benchmark_low": 25, "benchmark_high": 40, "target_value": 35, "current_rom": 33 },
                        { "name": "Structure", "benchmark_low": 50, "benchmark_high": 100, "target_value": 65, "current_rom": 57 },
                        { "name": "Envelope", "benchmark_low": 60, "benchmark_high": 84, "target_value": 70, "current_rom": 71 },
                        { "name": "Labs", "benchmark_low": 78, "benchmark_high": 120, "target_value": 88, "current_rom": 87 },
                        { "name": "Vertical Circulation", "benchmark_low": 29, "benchmark_high": 47, "target_value": 33, "current_rom": 34 },
                        { "name": "Plumbing", "benchmark_low": 22, "benchmark_high": 42, "target_value": 26, "current_rom": 25 },
                        { "name": "Electrical", "benchmark_low": 40, "benchmark_high": 60, "target_value": 48, "current_rom": 42 },
                        { "name": "HVAC", "benchmark_low": 38, "benchmark_high": 78, "target_value": 50, "current_rom": 48 },
                        { "name": "Fire Protection", "benchmark_low": 22, "benchmark_high": 42, "target_value": 28, "current_rom": 27 }
                    ]
                }
            }
        };
        let originalData = null, currentData = null, yDomainMax = 100, currentPhase = 'phase1';

        // --- DOM ELEMENT REFERENCES ---
        const splashScreen = document.getElementById('splash-screen'), mainContent = document.getElementById('main-content');
        const chartContainer = d3.select("#chart-container"), yAxisLabelsContainer = d3.select("#y-axis-labels-container");
        const resetButton = document.getElementById('reset-button'), startOverBtn = document.getElementById('start-over-btn');
        const exportJsonBtn = document.getElementById('export-json-btn'), useSampleDataBtn = document.getElementById('use-sample-data-btn');
        const exportCsvBtn = document.getElementById('export-csv-btn');
        const downloadTemplateBtn = document.getElementById('download-template-btn'), fileDropZone = document.getElementById('file-drop-zone');
        const fileInput = document.getElementById('file-input'), fileNameDisplay = document.getElementById('file-name');
        const phase1Btn = document.getElementById('phase1-btn'), phase2Btn = document.getElementById('phase2-btn');

        // --- SCALES AND FORMATTERS ---
        const yScale = d3.scaleLinear().domain([0, yDomainMax]);
        const formatCurrency = (d) => `$${d.toFixed(2)}`;

        // --- VIEW MANAGEMENT ---
        function showSplashScreen() { mainContent.style.display = 'none'; splashScreen.style.display = 'flex'; }
        function showMainContent() { splashScreen.style.display = 'none'; mainContent.style.display = 'block'; window.requestAnimationFrame(render); }

        // --- MAIN RENDER FUNCTION ---
        function render() {
            if (!currentData) return;

            const phaseComponents = currentData.phases[currentPhase].components;
            chartContainer.style("grid-template-columns", `repeat(${phaseComponents.length}, 1fr)`);
            yScale.range([chartContainer.node().clientHeight - parseFloat(chartContainer.style("padding-bottom")), 0]);
            
            if (currentPhase === 'phase1') {
                phase1Btn.classList.add('bg-blue-600', 'text-white');
                phase1Btn.classList.remove('bg-gray-300', 'text-gray-700', 'hover:bg-gray-400');
                phase2Btn.classList.add('bg-gray-300', 'text-gray-700', 'hover:bg-gray-400');
                phase2Btn.classList.remove('bg-blue-600', 'text-white');
            } else {
                phase2Btn.classList.add('bg-blue-600', 'text-white');
                phase2Btn.classList.remove('bg-gray-300', 'text-gray-700', 'hover:bg-gray-400');
                phase1Btn.classList.add('bg-gray-300', 'text-gray-700', 'hover:bg-gray-400');
                phase1Btn.classList.remove('bg-blue-600', 'text-white');
            }

            renderChart(); 
            updateSummary(); 
            renderYAxisLabels();
            resetButton.disabled = JSON.stringify(originalData) === JSON.stringify(currentData);
        }

        // --- CHART RENDERING ---
        function renderChart() {
            const components = chartContainer.selectAll(".component-column").data(currentData.phases[currentPhase].components, d => d.name);
            components.exit().remove();

            const enterGroup = components.enter().append("div").attr("class", "component-column");
            enterGroup.append("div").attr("class", "y-axis");
            enterGroup.append("div").attr("class", "benchmark-range");
            enterGroup.append("div").attr("class", "benchmark-cap benchmark-cap-low");
            enterGroup.append("div").attr("class", "benchmark-cap benchmark-cap-high");
            enterGroup.append("div").attr("class", "target-value");
            enterGroup.append("div").attr("class", "ghost-rom");
            enterGroup.append("div").attr("class", "current-rom").call(d3.drag().on("start", dragStarted).on("drag", dragged).on("end", dragEnded));
            enterGroup.append("div").attr("class", "component-label");
            const valueLabelGroup = enterGroup.append("div").attr("class", "value-label-group");
            valueLabelGroup.append("div").attr("class", "current-value-label");
            valueLabelGroup.append("div").attr("class", "delta-label");
            enterGroup.append("div").attr("class", "lock-icon").on("click", toggleLock);

            const updateGroup = enterGroup.merge(components);
            
            // FIX: Correctly position benchmark range using top/height
            updateGroup.select(".benchmark-range")
                .style("top", d => Math.min(yScale(d.benchmark_low), yScale(d.benchmark_high)) + "px")
                .style("height", d => Math.abs(yScale(d.benchmark_low) - yScale(d.benchmark_high)) + "px")
                .style("bottom", null); // remove conflicting style

            updateGroup.select(".benchmark-cap-low")
                .style("top", d => yScale(d.benchmark_low) + "px")
                .style("bottom", null);

            updateGroup.select(".benchmark-cap-high")
                .style("top", d => yScale(d.benchmark_high) + "px")
                .style("bottom", null);

            updateGroup.select(".target-value").style("top", d => yScale(d.target_value) + "px").style("bottom", null);
            updateGroup.select(".current-rom").style("top", d => yScale(d.current_rom) - 3 + "px").style("bottom", null);
            
            const originalComponents = originalData.phases[currentPhase].components.reduce((acc, val) => ({ ...acc, [val.name]: val }), {});
            updateGroup.each(function(d) {
                const original = originalComponents[d.name];
                if (!original) return; // Safeguard if a component name changes or is missing
                const valueGroup = d3.select(this).select(".value-label-group");
                valueGroup.select(".current-value-label").text(formatCurrency(d.current_rom));
                valueGroup.style("top", yScale(d.current_rom) - 10 + "px").style("bottom", null);

                const ghostBar = d3.select(this).select(".ghost-rom");
                ghostBar.style("top", yScale(original.current_rom) - 3 + "px").style("bottom", null);

                const deltaLabel = valueGroup.select(".delta-label");
                if (d.current_rom !== original.current_rom) {
                    ghostBar.style("display", "block");
                    const delta = d.current_rom - original.current_rom;
                    deltaLabel.style("display", "block").text(`${delta > 0 ? '+' : ''}${formatCurrency(delta)}`).style("color", delta > 0 ? '#dc2626' : '#16a34a');
                } else {
                    ghostBar.style("display", "none");
                    deltaLabel.style("display", "none");
                }
            });

            updateGroup.select(".component-label").text(d => d.name);
            updateGroup.select(".lock-icon")
                .style('display', 'block')
                .style('opacity', d => d.locked ? 1 : 0.5)
                .text(d => d.locked ? '🔒' : '🔓');
        }
        
        function renderYAxisLabels() {
            yAxisLabelsContainer.html('');
            const ticks = yScale.ticks(10);
            ticks.forEach(tick => {
                yAxisLabelsContainer.append('div')
                    .style('position', 'absolute')
                    .style('top', `${yScale(tick)}px`)
                    .style('transform', 'translateY(-50%)')
                    .text(tick);
            });
        }

        // --- DRAG LOGIC ---
        function dragStarted(event, d) { d3.select(this).raise().classed("active", true); if (!d.locked) { d.locked = true; render(); } }
        function dragged(event, d) {
            const newRomValue = Math.max(0, Math.min(yDomainMax, yScale.invert(event.y)));
            const romChange = newRomValue - d.current_rom;
            if (Math.abs(romChange) < 0.01) return;
            const unlockedComponents = currentData.phases[currentPhase].components.filter(c => c !== d && !c.locked);
            const totalUnlockedWeight = d3.sum(unlockedComponents, c => c.current_rom);
            if (unlockedComponents.length === 0 || totalUnlockedWeight <= 0) {
                 d.current_rom = newRomValue;
            } else {
                let remainingChange = -romChange;
                d.current_rom = Math.max(0, d.current_rom + romChange);
                unlockedComponents.forEach(comp => {
                    const proportion = totalUnlockedWeight > 0 ? comp.current_rom / totalUnlockedWeight : 1 / unlockedComponents.length;
                    let adjustment = remainingChange * proportion;
                    if (comp.current_rom + adjustment < 0) { adjustment = -comp.current_rom; remainingChange -= adjustment; }
                    comp.current_rom += adjustment;
                });
            }
            render();
        }
        function dragEnded() { d3.select(this).classed("active", false); }
        function toggleLock(event, d) { d.locked = !d.locked; render(); }

        // --- SUMMARY & FILE HANDLING ---
        function updateSummary() {
            // Phase 1
            const p1 = currentData.phases.phase1;
            const totalTargetP1 = d3.sum(p1.components, d => d.target_value);
            const totalCurrentP1 = d3.sum(p1.components, d => d.current_rom);
            const varianceP1 = totalCurrentP1 - totalTargetP1;
            document.getElementById('total-budget-p1').textContent = `$${p1.totalProjectBudget.toLocaleString()}`;
            document.getElementById('target-cost-p1').textContent = formatCurrency(totalTargetP1);
            document.getElementById('current-cost-p1').textContent = formatCurrency(totalCurrentP1);
            const varianceElP1 = document.getElementById('variance-p1');
            varianceElP1.textContent = `${varianceP1 > 0 ? '+' : ''}${formatCurrency(varianceP1)}`;
            varianceElP1.classList.toggle('text-red-600', varianceP1 > 0);
            varianceElP1.classList.toggle('text-green-600', varianceP1 <= 0);

            // Phase 2
            const p2 = currentData.phases.phase2;
            const totalTargetP2 = d3.sum(p2.components, d => d.target_value);
            const totalCurrentP2 = d3.sum(p2.components, d => d.current_rom);
            const varianceP2 = totalCurrentP2 - totalTargetP2;
            document.getElementById('total-budget-p2').textContent = `$${p2.totalProjectBudget.toLocaleString()}`;
            document.getElementById('target-cost-p2').textContent = formatCurrency(totalTargetP2);
            document.getElementById('current-cost-p2').textContent = formatCurrency(totalCurrentP2);
            const varianceElP2 = document.getElementById('variance-p2');
            varianceElP2.textContent = `${varianceP2 > 0 ? '+' : ''}${formatCurrency(varianceP2)}`;
            varianceElP2.classList.toggle('text-red-600', varianceP2 > 0);
            varianceElP2.classList.toggle('text-green-600', varianceP2 <= 0);
        }
        
        function loadData(data, fileName = 'Sample Data') {
            if (!data.phases || !data.phases.phase1 || !data.phases.phase2) { alert("Invalid JSON format. Must contain phase1 and phase2 data."); return; }
            
            Object.values(data.phases).forEach(phase => phase.components.forEach(c => c.locked = false));
            originalData = JSON.parse(JSON.stringify(data));
            currentData = data;
            
            const allComponents = [...data.phases.phase1.components, ...data.phases.phase2.components];
            const maxVal = d3.max(allComponents, d => Math.max(d.benchmark_high, d.target_value, d.current_rom));
            yDomainMax = Math.ceil(maxVal / 10) * 10 + 20;
            yScale.domain([0, yDomainMax]); // 0 at bottom, max at top
            fileNameDisplay.textContent = `Using: ${fileName}`;
            currentPhase = 'phase1'; // Reset to phase 1 on new data load
            showMainContent();
        }

        function handleFile(file) {
            if (file && file.type === 'application/json') {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const jsonData = JSON.parse(e.target.result);
                        loadData(jsonData, file.name);
                    } catch (error) {
                        alert("Error parsing JSON file: " + error.message);
                    }
                };
                reader.readAsText(file);
            } else { alert("Please upload a valid JSON file."); }
        }

        function downloadTemplate() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(sampleData, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "tvd_template.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function exportJSON() {
            if (!currentData) return;
            const dataToExport = JSON.parse(JSON.stringify(currentData));
            Object.values(dataToExport.phases).forEach(phase => {
                phase.components.forEach(c => delete c.locked);
            });
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(dataToExport, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", `tvd_export_${new Date().toISOString().split('T')[0]}.json`);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function exportCSV() {
            if (!currentData) return;

            const headers = ["Phase", "Component", "Benchmark Low", "Benchmark High", "Target Value", "Current ROM"];
            let csvContent = headers.join(",") + "\n";

            for (const phaseKey in currentData.phases) {
                if (currentData.phases.hasOwnProperty(phaseKey)) {
                    const phase = currentData.phases[phaseKey];
                    phase.components.forEach(component => {
                        const row = [
                            phaseKey,
                            `"${component.name.replace(/"/g, '""')}"`, // Handle quotes in name
                            component.benchmark_low,
                            component.benchmark_high,
                            component.target_value,
                            component.current_rom
                        ].join(",");
                        csvContent += row + "\n";
                    });
                }
            }

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", url);
            downloadAnchorNode.setAttribute("download", `tvd_export_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            URL.revokeObjectURL(url);
        }

        // --- EVENT LISTENERS ---
        useSampleDataBtn.addEventListener('click', () => loadData(sampleData));
        downloadTemplateBtn.addEventListener('click', downloadTemplate);
        startOverBtn.addEventListener('click', showSplashScreen);
        exportJsonBtn.addEventListener('click', exportJSON);
        exportCsvBtn.addEventListener('click', exportCSV);
        resetButton.addEventListener('click', () => { if (originalData) { loadData(JSON.parse(JSON.stringify(originalData)), fileNameDisplay.textContent.replace('Using: ', '')); } });
        
        phase1Btn.addEventListener('click', () => { currentPhase = 'phase1'; render(); });
        phase2Btn.addEventListener('click', () => { currentPhase = 'phase2'; render(); });

        fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));
        fileDropZone.addEventListener('click', () => fileInput.click());
        fileDropZone.addEventListener('dragover', (e) => { e.preventDefault(); fileDropZone.classList.add('dragover'); });
        fileDropZone.addEventListener('dragleave', () => fileDropZone.classList.remove('dragover'));
        fileDropZone.addEventListener('drop', (e) => { e.preventDefault(); fileDropZone.classList.remove('dragover'); handleFile(e.dataTransfer.files[0]); });
        window.addEventListener('resize', render);
    </script>
</body>
</html>
